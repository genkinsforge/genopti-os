<!DOCTYPE html>
<html>
<head>
  <title>License Scanner</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #header {
      background-color: #333;
      color: white;
      padding: 1rem;
      text-align: center;
      flex: 0 0 auto;
    }

    #header h1 {
      margin: 0;
      font-size: 1.2em;
      color: white;
      opacity: 0.8;
    }

    #header h2 {
      margin: 0.5em 0 0 0;
      font-size: 1.8em;
      color: white;
      font-weight: bold;
    }

    #content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }

    #scanner-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    #result-display {
      flex: 1;
      margin-top: 1rem;
      padding: 2rem;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    /* We do NOT apply .invalid while scanning. We keep it for actual parse errors. */
    .valid {
      background-color: #90EE90;
    }
    .invalid {
      background-color: #FFB6C1;
    }

    .result-text {
      font-size: 1.2em;
      margin: 0.5em 0;
    }

    .validation-message {
      font-size: 1.5em;
      font-weight: bold;
      text-align: center;
      margin-top: 1em;
    }
  </style>
</head>
<body 
  data-debug-mode="{{ debug_mode|tojson }}" 
  data-reset-secs="{{ scan_reset_seconds|tojson }}"
  data-inactivity-ms="{{ scan_inactivity_ms|tojson }}"
>
  <div id="header">
    <h1 id="current-date"></h1>
    <h2 id="twenty-one-date"></h2>
  </div>

  <div id="content">
    <input type="text" id="scanner-input" autocomplete="off">
    <div id="result-display">
      <p class="result-text" id="name-display"></p>
      <p class="result-text" id="address-display"></p>
      <p class="result-text" id="dob-display"></p>
      <p class="result-text" id="expiration-display"></p>
      <p class="result-text" id="raw-data-display" style="white-space: pre-wrap;"></p>
      <p class="validation-message" id="validation-message"></p>
    </div>
  </div>

  <script>
    const debugMode = (document.body.dataset.debugMode === "true");
    const resetSecs = parseInt(document.body.dataset.resetSecs || "15", 10);
    const inactivityMs = parseInt(document.body.dataset.inactivityMs || "300", 10);

    function updateDate() {
      const now = new Date();
      const opts = { year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('current-date').textContent =
        "Current Date: " + now.toLocaleDateString('en-US', opts);

      const cutoff = new Date(now);
      cutoff.setFullYear(now.getFullYear() - 21);
      document.getElementById('twenty-one-date').textContent =
        "Must be born before " + cutoff.toLocaleDateString('en-US', opts) + " to be 21+";
    }
    updateDate();
    setInterval(updateDate, 60000);

    const inputField = document.getElementById('scanner-input');
    inputField.focus();
    document.addEventListener('click', () => inputField.focus());

    let scanBuffer = '';
    let scanTimeout = null;
    let scanning = false; // track if we are currently scanning
    let resetTimer = null;

    inputField.addEventListener('input', (e) => {
      if (!scanning) {
        scanning = true;
        showReadingMessage();  // no red, just "Reading scanning data..."
      }

      scanBuffer += e.target.value;
      inputField.value = '';

      clearTimeout(scanTimeout);
      scanTimeout = setTimeout(() => {
        finalizeScan(scanBuffer.trim());
        scanBuffer = '';
        scanning = false;
      }, inactivityMs);
    });

    function showReadingMessage() {
      // Instead of filling placeholders with "undefined" or coloring red, 
      // we simply display "Reading scanning data..." 
      // and keep background neutral (no invalid class).
      const rd = document.getElementById('result-display');
      rd.className = ""; // keep background normal
      document.getElementById('name-display').textContent        = "";
      document.getElementById('address-display').textContent     = "";
      document.getElementById('dob-display').textContent         = "";
      document.getElementById('expiration-display').textContent  = "";
      document.getElementById('raw-data-display').textContent    = "";
      document.getElementById('validation-message').textContent  = "Reading scanning data...";
    }

    async function finalizeScan(finalData) {
      if(!finalData) {
        hideReadingMessage(); // user typed nothing or it got cleared
        return;
      }
      try {
        const resp = await fetch('/process_scan', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ scan_data: finalData })
        });
        const result = await resp.json();
        updateDisplay(result);
      } catch(err) {
        console.error('Error finalizing scan:', err);
        showError('Error finalizing scan data');
      }
    }

    function updateDisplay(result) {
      hideReadingMessage();

      const rd = document.getElementById('result-display');
      document.getElementById('raw-data-display').textContent =
        debugMode && result.raw_scanned_data
          ? "Raw Data:\n" + result.raw_scanned_data
          : "";

      if(!result.success) {
        rd.className = 'invalid'; // red background only for actual parse error
        document.getElementById('name-display').textContent        = "";
        document.getElementById('address-display').textContent     = "";
        document.getElementById('dob-display').textContent         = "";
        document.getElementById('expiration-display').textContent  = "";
        document.getElementById('validation-message').textContent  = result.error || "Error parsing data";
        return;
      }

      // success => final parse
      rd.className = result.is_valid ? 'valid' : 'invalid';
      document.getElementById('name-display').textContent        = "Name: " + (result.name || "");
      document.getElementById('address-display').textContent     = "Address: " + (result.address || "");
      document.getElementById('dob-display').textContent         = "Date of Birth: " + (result.dob || "");
      document.getElementById('expiration-display').textContent  = "License Expiration: " + (result.expiration || "");
      document.getElementById('validation-message').textContent  = result.validation_message || "";

      if (resetSecs > 0) {
        clearTimeout(resetTimer);
        resetTimer = setTimeout(clearScreen, resetSecs * 1000);
      }
    }

    function hideReadingMessage() {
      const vm = document.getElementById('validation-message');
      if (vm.textContent === "Reading scanning data...") {
        vm.textContent = "";
      }
    }

    function showError(msg) {
      hideReadingMessage();
      const rd = document.getElementById('result-display');
      rd.className = 'invalid';
      document.getElementById('name-display').textContent        = "";
      document.getElementById('address-display').textContent     = "";
      document.getElementById('dob-display').textContent         = "";
      document.getElementById('expiration-display').textContent  = "";
      document.getElementById('raw-data-display').textContent    = "";
      document.getElementById('validation-message').textContent  = "ERROR: " + msg;
    }

    function clearScreen() {
      const rd = document.getElementById('result-display');
      rd.className = "";
      document.getElementById('name-display').textContent        = "";
      document.getElementById('address-display').textContent     = "";
      document.getElementById('dob-display').textContent         = "";
      document.getElementById('expiration-display').textContent  = "";
      document.getElementById('raw-data-display').textContent    = "";
      document.getElementById('validation-message').textContent  = "";
    }
  </script>
</body>
</html>

